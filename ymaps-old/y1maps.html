<!DOCTYPE html>
<html lang="ru-RU">
  <head>
    <title>Маршрут от точки на карте</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width">
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
    </style>
  </head>
  <body>
    <div id="viewContainer"></div>
    <div id="map"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
    <script>
      ymaps.modules.define('MultiRouteCustomView', [
          'util.defineClass'
      ], function (provide, defineClass) {
          // Класс простого текстового отображения модели мультимаршрута.
          function CustomView (multiRouteModel) {
              this.multiRouteModel = multiRouteModel;
              // Объявляем начальное состояние.
              this.state = "init";
              this.stateChangeEvent = null;
              // Элемент, в который будет выводиться текст.
              this.outputElement = $('<div></div>').appendTo('#viewContainer');

              this.rebuildOutput();

              // Подписываемся на события модели, чтобы
              // обновлять текстовое описание мультимаршрута.
              multiRouteModel.events
                  .add(["requestsuccess", "requestfail", "requestsend"], this.onModelStateChange, this);
          }

          // Таблица соответствия идентификатора состояния имени его обработчика.
          CustomView.stateProcessors = {
              init: "processInit",
              requestsend: "processRequestSend",
              requestsuccess: "processSuccessRequest",
              requestfail: "processFailRequest"
          };

          // Таблица соответствия типа маршрута имени его обработчика.
          CustomView.routeProcessors = {
              "masstransit": "processMasstransitRoute",
              "driving": "processDrivingRoute",
              "pedestrian": "processPedestrianRoute"
          };

          defineClass(CustomView, {
              // Обработчик событий модели.
              onModelStateChange: function (e) {
                  // Запоминаем состояние модели и перестраиваем текстовое описание.
                  this.state = e.get("type");
                  this.stateChangeEvent = e;
                  this.rebuildOutput();
              },

              rebuildOutput: function () {
                  // Берем из таблицы обработчик для текущего состояния и исполняем его.
                  var processorName = CustomView.stateProcessors[this.state];
                  this.outputElement.html(
                      this[processorName](this.multiRouteModel, this.stateChangeEvent)
                  );
              },

              processInit: function () {
                  return "Инициализация ...";
              },

              processRequestSend: function () {
                  return "Запрос данных ...";
              },

              processSuccessRequest: function (multiRouteModel, e) {
                  var routes = multiRouteModel.getRoutes(),
                      result = ["Данные успешно получены."];
                  if (routes.length) {
                      result.push("Всего маршрутов: " + routes.length + ".");
                      for (var i = 0, l = routes.length; i < l; i++) {
                          result.push(this.processRoute(i, routes[i]));
                      }
                  } else {
                      result.push("Нет маршрутов.");
                  }
                  return result.join("<br/>");
              },

              processFailRequest: function (multiRouteModel, e) {
                  return e.get("error").message;
              },

              processRoute: function (index, route) {
                  // Берем из таблицы обработчик для данного типа маршрута и применяем его.
                  var processorName = CustomView.routeProcessors[route.properties.get("type")];
                  return (index + 1) + ". " + this[processorName](route);
              },

              processMasstransitRoute: function (route) {
                  // console.log(route);
                  var result = ["Маршрут на общественном транспорте."];
                  result.push(this.createCommonRouteOutput(route));
                  result.push("Описание маршута: <ul>" + this.createMasstransitRouteOutput(route) + "</ul>");
                  return result.join("<br/>");
              },

              processDrivingRoute: function (route) {
                  var result = ["Автомобильный маршрут."];
                  result.push(this.createCommonRouteOutput(route));
                  return result.join("<br/>");
              },

              processPedestrianRoute: function (route) {
                  var result = ["Пешеходный маршрут."];
                  result.push(this.createCommonRouteOutput(route));
                  return result.join("<br/>");
              },

              // Метод, формирующий общую часть описания для всех типов маршрутов.
              createCommonRouteOutput: function (route) {
                  return "Протяженность маршрута: " + route.properties.get("distance").text + "<br/>" +
                      "Время в пути: " + route.properties.get("duration").text;
              },

              // Метод, строящий список текстовых описаний для
              // всех сегментов маршрута на общественном транспорте.
              createMasstransitRouteOutput: function (route) {
                  var result = [];
                  var transports = {
                    tramway: 'Трамвай',
                    trolleybus: 'Троллейбус',
                    bus: 'Автобус',
                    minibus: 'Маршрутка'
                  };
                  for (var i = 0, l = route.getPaths().length; i < l; i++) {
                      var path = route.getPaths()[i];
                      for (var j = 0, k = path.getSegments().length; j < k; j++) {
                        var point = path.getSegments()[j].properties;
                          result.push("<li>" + point.get("text") + "</li>");
                          if (point.get("transports") != undefined) {
                            console.log('***');
                            point.get("transports").forEach(function(transport) {
                                console.log(transports[transport.type] + ": " + transport.name);
                            });
                          }
                      }
                  }
                  return result.join("");
              },

              destroy: function () {
                  this.outputElement.remove();
                  this.multiRouteModel.events
                      .remove(["requestsuccess", "requestfail", "requestsend"], this.onModelStateChange, this);
              }
          });

          provide(CustomView);
      });
      ymaps.ready(function () {
          var myMap = new ymaps.Map('map', {
              center: [55.1795, 61.3449],
              zoom: 16,
              // Добавим панель маршрутизации.
              controls: ['routePanelControl']
          });

          // Создание экземпляра маршрута.
          var multiRoute = new ymaps.multiRouter.MultiRoute({
              referencePoints: [
                  [55.1795, 61.3449],
                  [55.195015, 61.334515]
              ],
              params: {
                  // Тип маршрута: на общественном транспорте.
                  routingMode: "masstransit"  
              }
          }, {
              // Автоматически устанавливать границы карты так,
              // чтобы маршрут был виден целиком.
              boundsAutoApply: true
          });
          ymaps.modules.require([
              'MultiRouteCustomView'
          ], function (MultiRouteCustomView) {
              // Создаем экземпляр текстового отображения модели мультимаршрута.
              // см. файл custom_view.js
              new MultiRouteCustomView(multiRoute);
          });

          // Добавление маршрута на карту.
          myMap.geoObjects.add(multiRoute);

          var control = myMap.controls.get('routePanelControl');

          control.options.set({
              // Список всех опций см. в справочнике.   
              maxWidth: '100%',
              float: 'right'
          });

          // Зададим состояние панели для построения машрутов.
          control.routePanel.state.set({
              // Тип маршрутизации.
              type: 'masstransit',
              // Выключим возможность задавать пункт отправления в поле ввода.
              fromEnabled: false,
              // Адрес или координаты пункта отправления.
              from: [55.1795, 61.3449],
              // Включим возможность задавать пункт назначения в поле ввода.
              toEnabled: true
              // Адрес или координаты пункта назначения.
              //to: 'Петербург'
          });

          // Зададим опции панели для построения машрутов.
          control.routePanel.options.set({
              // Запрещаем показ кнопки, позволяющей менять местами начальную и конечную точки маршрута.
              allowSwitch: true,
              // Включим определение адреса по координатам клика.
              // Адрес будет автоматически подставляться в поле ввода на панели, а также в подпись метки маршрута.
              // reverseGeocoding: true,
              // Зададим виды маршрутизации, которые будут доступны пользователям для выбора.
              types: { masstransit: true, pedestrian: true, taxi: true }
          });

          // Создаем кнопку, с помощью которой пользователи смогут менять местами начальную и конечную точки маршрута.
          var switchPointsButton = new ymaps.control.Button({
              data: {content: "Поменять местами", title: "Поменять точки местами"},
              options: {selectOnClick: false}
          });
          // Объявляем обработчик для кнопки.
          switchPointsButton.events.add('click', function () {
              // Меняет местами начальную и конечную точки маршрута.
              control.routePanel.switchPoints();
          });
          myMap.controls.add(switchPointsButton);
      });
    </script>
  </body>
</html>
